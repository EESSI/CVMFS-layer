BootStrap: docker
From: centos:7

%post
    yum update -y
    yum install -y squid which

%environment
    export LC_ALL=C

%runscript
    if [[ ${1:0:1} = '-' ]]; then
        EXTRA_ARGS="$@"
        set --
    elif [[ ${1} == squid || ${1} == $(which squid) ]]; then
        EXTRA_ARGS="${@:2}"
        set --
    fi

    if [[ -z ${1} ]]; then
        if [[ ! -d /var/spool/squid/00 ]]; then
            echo "Initializing cache..."
            $(which squid) -N -f /etc/squid/squid.conf -z
        fi
        echo "Starting squid..."
        exec $(which squid) -f /etc/squid/squid.conf -NYCd 1 ${EXTRA_ARGS}
    else
        exec "$@"
    fi

%startscript
    if [[ ${1:0:1} = '-' ]]; then
        EXTRA_ARGS="$@"
        set --
    elif [[ ${1} == squid || ${1} == $(which squid) ]]; then
        EXTRA_ARGS="${@:2}"
        set --
    fi

    if [[ -z ${1} ]]; then
        if [[ ! -d /var/spool/squid/00 ]]; then
            echo "Initializing cache..."
            $(which squid) -N -f /etc/squid/squid.conf -z
        fi
        echo "Starting squid..."
        exec $(which squid) -f /etc/squid/squid.conf -NYCd 1 ${EXTRA_ARGS}
    else
        exec "$@"
    fi
